<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Sensor Dashboard</title>
</head>
<body>

<h1>Dashboard Sensore</h1>

<select id="sensor_selection" onchange="OnChange()">
    <option value="temperature">temperature</option>
    <option value="humidity">humidity</option>
    <option value="pressure">pressure</option>
</select>

<h3>Dati grezzi (MQTT)</h3>
<pre id="raw">---</pre>

<h3>Dati formattati</h3>
<p id="formatted">---</p>

<h3>Chart.js</h3>
<p id="chart_js">---</p>

<canvas id="chart"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ws = new WebSocket("ws://localhost:8888/ws");

    const raw = document.getElementById("raw");
    const formatted = document.getElementById("formatted");

    const dom_selected_sensor = document.getElementById("sensor_selection");
    let selected_sensor = "temperature";

    const ctx = document.getElementById("chart");
    let chart = null;

    function OnChange(){
        selected_sensor = dom_selected_sensor.value;

        // prima di creare un nuovo chart distruggo quello vecchio, se c'Ã¨
        if (chart) {
            chart.destroy();
            chart = null;
        }

        // crea nuovo chart ogni volta che seleziono un sensore
        chart = new Chart(ctx, {
            type: "line",        // tipo di grafico (line = grafico a linee)
            data: {
                labels: [],      // asse orizzontale (tempo, indice, ecc.)
                datasets: [{
                    label: selected_sensor, // nome della linea nel grafico
                    data: [], // valori numerici del sensore
                    borderWidth: 2
                }]
            },
            options: {
                animation: false
            }
        });

    };
    OnChange();

    ws.onopen = () => {
        console.log("WebSocket aperto");
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        // gestisce solo messaggi di tipo sensore
        if (msg.type !== "sensor") return;

        const data = msg.data;

        // filtra solo il sensore selezionato
        if (data.sensor !== selected_sensor) return;

        // dati grezzi
        raw.textContent = JSON.stringify(data, null, 2);

        // dati formattati
        formatted.textContent =
            `${selected_sensor}: ${data.value} ${data.unit} (ore ${data.time_stamp})`;

        // aggiorno il chart
        chart.data.labels.push(data.time_stamp);
        chart.data.datasets[0].data.push(data.value);
        if (chart.data.labels.length > 30) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
        }
        chart.update();
    };

    ws.onclose = () => {
        console.log("WebSocket chiuso");
    };

</script>
</body>
</html>